
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Scraping-S&amp;P-500-Components-from-Wikipedia">Scraping S&amp;P 500 Components from Wikipedia<a class="anchor-link" href="#Scraping-S&amp;P-500-Components-from-Wikipedia">&#182;</a></h2><h3 id="What-we're-going-to-do:">What we're going to do:<a class="anchor-link" href="#What-we're-going-to-do:">&#182;</a></h3><ol>
<li>Scrape wikipedia for lists of: <ul>
<li>Current companies in the S&amp;P 500 </li>
<li>Historical changes to the S&amp;P 500 </li>
</ul>
</li>
<li>Write a function to generate the list of companies in the index as of a given date </li>
</ol>
<h3 id="Background">Background<a class="anchor-link" href="#Background">&#182;</a></h3><p>Getting the current list of companies in the S&amp;P 500 is pretty easy so we're gonna tackle that first. Reconstructing the index historically isn't so easy. Since the index is regularly rebalanced, we need a list of all the companies added and removed from the index and the date the change occurred.</p>
<p>Wikipedia is nice enough to make this data available, but as we'll see shortly, the format of the table of company changes is a little tricky and requires some web scraping gymnastics to get it into a useable format for analysis. Let's get to it.</p>
<p><strong>Attribution:</strong> Two of the big problems I ran into were solved by a fellow named Andy Roche and he was nice enough to write a blog post with his approach an code. <a href="https://roche.io/2016/05/scrape-wikipedia-with-python">Here's his post</a> so be sure to check that out for a more thorough approach to wikipedia tables.</p>
<h3 id="Preliminaries">Preliminaries<a class="anchor-link" href="#Preliminaries">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="k">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">datetime</span> 
<span class="kn">import</span> <span class="nn">re</span> 

<span class="c1"># wikipedia page with our target tables and the initial web request </span>
<span class="n">WIKI_URL</span> <span class="o">=</span> <span class="s2">&quot;https://en.wikipedia.org/wiki/List_of_S%26P_500_companies&quot;</span>
<span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">WIKI_URL</span><span class="p">)</span>
<span class="n">req</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

<span class="c1"># here we search for all the tables on the web page and get them into a </span>
<span class="c1"># beautiful soup result set  </span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;lxml&#39;</span><span class="p">)</span>
<span class="n">table_classes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;sortable&quot;</span><span class="p">,</span> <span class="s2">&quot;plainrowheaders&quot;</span><span class="p">]}</span>
<span class="n">wikitables</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="n">table_classes</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">wikitables</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[2]:</div>



<div class="output_text output_subarea output_execute_result">
<pre>bs4.element.ResultSet</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Parsing-the-table-of-current-companies">Parsing the table of current companies<a class="anchor-link" href="#Parsing-the-table-of-current-companies">&#182;</a></h3><p>We're interested in the first two tables on the page web page. The first table is a pretty clean HTML table that lists all the companies currently in the S&amp;P 500. We're going to traverse the table, clean thing up a bit, then store the results in a list for use later. Note the regular expression to strip out the wikipedia footnotes.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">wikitables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;tr&quot;</span><span class="p">)</span>

<span class="c1">#parse data from table by extracting each table row (&quot;tr&quot; tags) </span>
<span class="n">current_companies_list</span> <span class="o">=</span> <span class="p">[]</span>   
<span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">rows</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
        <span class="n">row_cells</span> <span class="o">=</span> <span class="p">[</span><span class="n">th</span><span class="o">.</span><span class="n">getText</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">tr</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;th&#39;</span><span class="p">)</span> 
                        <span class="k">if</span> <span class="n">th</span><span class="o">.</span><span class="n">getText</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>  
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">row_cells</span> <span class="o">=</span> <span class="p">(([</span><span class="n">tr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;th&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getText</span><span class="p">()]</span> <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;th&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> 
                        <span class="o">+</span> <span class="p">[</span><span class="n">td</span><span class="o">.</span><span class="n">getText</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">td</span> <span class="ow">in</span> <span class="n">tr</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">)])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_cells</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> 
        <span class="c1"># strip out brackets from reference links </span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row_cells</span><span class="p">):</span> 
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> 
                <span class="n">row_cells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[\[].*?[\]]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
        <span class="n">current_companies_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">row_cells</span><span class="p">]</span>
        
<span class="n">current_companies_list</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[7]:</div>



<div class="output_text output_subarea output_execute_result">
<pre>[[&#39;Symbol&#39;,
  &#39;Security&#39;,
  &#39;SEC filings&#39;,
  &#39;GICS Sector&#39;,
  &#39;GICS Sub Industry&#39;,
  &#39;Headquarters Location&#39;,
  &#39;Date first added&#39;,
  &#39;CIK&#39;,
  &#39;Founded&#39;],
 [&#39;MMM&#39;,
  &#39;3M Company&#39;,
  &#39;reports&#39;,
  &#39;Industrials&#39;,
  &#39;Industrial Conglomerates&#39;,
  &#39;St. Paul, Minnesota&#39;,
  &#39;&#39;,
  &#39;0000066740&#39;,
  &#39;1902&#39;],
 [&#39;ABT&#39;,
  &#39;Abbott Laboratories&#39;,
  &#39;reports&#39;,
  &#39;Health Care&#39;,
  &#39;Health Care Equipment&#39;,
  &#39;North Chicago, Illinois&#39;,
  &#39;1964-03-31&#39;,
  &#39;0000001800&#39;,
  &#39;1888&#39;]]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we have a clean list where the first element is a list of headers and each element after it relates to a single company. We're mostly interested in the ticker symbol for each company but it doesn't hurt too keep the additional reference info for now. Not too shabby!</p>
<p><strong>Next comes the hard part:</strong> the history of changes to the index components. The second table has the data we need but it also has lots of rows where a single data element spans multiple rows. This isn't good for data analysis so here's what we have to do:</p>
<ul>
<li>The first column is the date a change occurred so we'll write a helper function to check if it's a date<ul>
<li>If we find a date, we'll hold it in a temporary variable and repeat it for each row it spans in the original HTML table  </li>
</ul>
</li>
<li>Next we'll clean the data so we wind up with one list element per change, in the following format: <ul>
<li>[Date, Added, Removed, Reason]</li>
</ul>
</li>
<li>We also need to explicitly keep blank cells (sometimes companies are added and none are removed or vice versa) </li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#get table of changes into bs4 result set </span>
<span class="n">row_chgs</span> <span class="o">=</span> <span class="n">wikitables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;tr&quot;</span><span class="p">)</span>

<span class="c1">#function to check if first element is a date </span>
<span class="k">def</span> <span class="nf">date_check</span><span class="p">(</span><span class="n">date_text</span><span class="p">):</span> 
    <span class="k">try</span><span class="p">:</span> 
        <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_text</span><span class="p">,</span> <span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">, %Y&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span> 
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> 
        <span class="k">return</span> <span class="kc">False</span> 

<span class="c1"># parse data as is</span>
<span class="n">company_changes_list</span><span class="p">,</span> <span class="n">date_holder</span><span class="p">,</span> <span class="n">reason_holder</span> <span class="o">=</span> <span class="p">[],</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
<span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">row_chgs</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">row_chgs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
        <span class="n">row_cells</span> <span class="o">=</span> <span class="p">[</span><span class="n">th</span><span class="o">.</span><span class="n">getText</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">tr</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;th&#39;</span><span class="p">)</span> 
                        <span class="k">if</span> <span class="n">th</span><span class="o">.</span><span class="n">getText</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>  
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">row_cells</span> <span class="o">=</span> <span class="p">(([</span><span class="n">tr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;th&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getText</span><span class="p">()]</span> <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;th&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span> 
                        <span class="o">+</span> <span class="p">[</span><span class="n">td</span><span class="o">.</span><span class="n">getText</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">td</span> <span class="ow">in</span> <span class="n">tr</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">)])</span>
        <span class="c1"># check if element is a date </span>
        <span class="k">if</span> <span class="n">date_check</span><span class="p">(</span><span class="n">row_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> 
            <span class="n">date_holder</span> <span class="o">=</span> <span class="n">row_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">reason_holder</span> <span class="o">=</span> <span class="n">row_cells</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">row_cells</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">date_holder</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_cells</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span> 
                <span class="n">row_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reason_holder</span><span class="p">)</span> 
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_cells</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> 
        <span class="c1"># strip out brackets from reference links </span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_cells</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span> 
            <span class="n">row_cells</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[\[].*?[\]]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">row_cells</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">company_changes_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">row_cells</span><span class="p">]</span>

<span class="n">company_changes_list</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[9]:</div>



<div class="output_text output_subarea output_execute_result">
<pre>[[&#39;Date&#39;, &#39;Added&#39;, &#39;Removed&#39;, &#39;Reason&#39;],
 [&#39;&#39;, &#39;Ticker&#39;],
 [&#39;January 2, 2019&#39;,
  &#39;FRC&#39;,
  &#39;First Republic Bank&#39;,
  &#39;SCG&#39;,
  &#39;SCANA&#39;,
  &#39;Dominion Energy acquiring SCANA Corporation&#39;],
 [&#39;December 24, 2018&#39;,
  &#39;CE&#39;,
  &#39;Celanese Corp.&#39;,
  &#39;ESRX&#39;,
  &#39;Express Scripts&#39;,
  &#39;S&amp;P 500 constituent Cigna (NYSE: CI) acquired ESRX&#39;],
 [&#39;December 3, 2018&#39;,
  &#39;LW&#39;,
  &#39;Lamb Weston Holdings Inc&#39;,
  &#39;COL&#39;,
  &#39;Rockwell Collins Inc&#39;,
  &#39;UTX acquires COL &#39;],
 [&#39;December 3, 2018&#39;,
  &#39;MXIM&#39;,
  &#39;Maxim Integrated Products Inc&#39;,
  &#39;AET&#39;,
  &#39;Aetna Inc&#39;,
  &#39;CVS acquires Aetna&#39;]]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ok we're good to go! Notice the second element of the list has a junk entry in it since the table headers aren't consistent - such is life when scraping data from the web!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

</div>
</div>
</div>

</div>
 

